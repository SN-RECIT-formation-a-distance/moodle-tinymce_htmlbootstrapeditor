{"version":3,"file":"wrapper.min.js","sources":["../src/wrapper.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n *\n * @module      tiny_htmlbootstrapeditor/plugin\n * @copyright  2019 RECIT\n * @license    {@link http://www.gnu.org/licenses/gpl-3.0.html} GNU GPL v3 or later\n */\n///import {get_string as getString} from 'core/str';\nimport {getFilePicker} from 'editor_tiny/options';\n\nexport class Editor {\n    globalVars = {popup: null};\n\n    open(editor){\n        //if the reference exists and the window is not closed\n        //so we can bring it to the front with the method focus() method without having to recreate the window\n        if(this.globalVars.popup !== null && !this.globalVars.popup.closed){\n            this.globalVars.popup.focus();\n            return;\n        }\n\n        var that = this;\n\n        var url = M.cfg.wwwroot;\n        url += \"/admin/tool/htmlbootstrapeditor/view.php\";\n\n        this.globalVars.popup = window.open(url, 'HTML Bootstrap Editor', 'scrollbars=1');\n\n        /*if (this.globalVars.popup.outerWidth < screen.availWidth || this.globalVars.popup.outerHeight < screen.availHeight){\n            this.globalVars.popup.moveTo(0,0);\n            this.globalVars.popup.resizeTo(screen.availWidth, screen.availHeight);\n        }*/\n\n        this.globalVars.popup.IWrapper = M.recit.htmlbootstrapeditor.IWrapper;\n\n        this.globalVars.popup.IWrapper.uploadFile = function(filename, binFile, cb){\n\n            let fileTransferData = that.getFileTransferData();\n            let xhr = new XMLHttpRequest();\n            xhr.onreadystatechange = () => cb(xhr);\n\n            let formData = new FormData();\n            formData.append('repo_upload_file', binFile);\n            formData.append('itemid', fileTransferData.itemid);\n            formData.append('env', fileTransferData.env);\n            formData.append('repo_id', fileTransferData.repo_id);\n            formData.append('sesskey', M.cfg.sesskey);\n            formData.append('client_id', fileTransferData.client_id);\n            formData.append('savepath', \"/\");\n            formData.append('ctx_id', M.cfg.contextid);\n            formData.append('license', fileTransferData.license);\n            formData.append('author', fileTransferData.author);\n\n            let tmp = filename.split(\".\");\n            filename = [(tmp[0] || \"\"), (tmp[1] || \"\")];\n            formData.append('title', `${filename[0].substr(0,255)}.${filename[1]}`);\n\n            xhr.open(\"POST\", M.cfg.wwwroot + '/repository/repository_ajax.php?action=upload', true);\n            xhr.send(formData);\n        };\n\n        this.globalVars.popup.IWrapper.get_string = function(str){\n            if (typeof M == 'undefined'){\n                return str;\n            }\n            //let moodle = M || window.parent.M;\n            return M.util.get_string(str, 'tool_htmlbootstrapeditor');\n        };\n\n        this.getFileTransferData = function(){\n            const options = getFilePicker(editor, 'media');\n\n            var result = {};\n            result.repo_id = 0 || 0;\n            result.client_id = options.client_id || 0;\n            result.env = options.env || '';\n            result.license = options.defaultlicense || '';\n            result.itemid = options.itemid || 0;\n            result.author = options.author || '';\n\n            var attr = '';\n            for(attr in options.repositories){\n                if (options.repositories[attr].type === 'upload') {\n                    result.repo_id = options.repositories[attr].id;\n                    break;\n                }\n            }\n\n            for(attr in options.licenses){\n                if (options.licenses[attr].shortname === 'cc') { // creative commons\n                    result.license = options.licenses[attr].shortname;\n                    break;\n                }\n            }\n\n            return result;\n        };\n\n        this.globalVars.popup.IWrapper.getContent = function(){\n            return editor.getContent();\n        };\n\n        this.globalVars.popup.IWrapper.setContent = function(htmlStr){\n            editor.execCommand('mceInsertContent', false, htmlStr);\n            that.globalVars.popup.close();\n        };\n\n    }\n}"],"names":["popup","open","editor","this","globalVars","closed","that","url","M","cfg","wwwroot","window","IWrapper","recit","htmlbootstrapeditor","uploadFile","filename","binFile","cb","fileTransferData","getFileTransferData","xhr","XMLHttpRequest","onreadystatechange","formData","FormData","append","itemid","env","repo_id","sesskey","client_id","contextid","license","author","tmp","split","substr","send","get_string","str","util","options","result","defaultlicense","attr","repositories","type","id","licenses","shortname","getContent","setContent","htmlStr","execCommand","close","focus"],"mappings":"oPAyBiB,CAACA,MAAO,2IAErBC,KAAKC,WAG4B,OAA1BC,KAAKC,WAAWJ,OAAmBG,KAAKC,WAAWJ,MAAMK,YAKxDC,KAAOH,KAEPI,IAAMC,EAAEC,IAAIC,QAChBH,KAAO,gDAEFH,WAAWJ,MAAQW,OAAOV,KAAKM,IAAK,wBAAyB,qBAO7DH,WAAWJ,MAAMY,SAAWJ,EAAEK,MAAMC,oBAAoBF,cAExDR,WAAWJ,MAAMY,SAASG,WAAa,SAASC,SAAUC,QAASC,QAEhEC,iBAAmBb,KAAKc,sBACxBC,IAAM,IAAIC,eACdD,IAAIE,mBAAqB,IAAML,GAAGG,SAE9BG,SAAW,IAAIC,SACnBD,SAASE,OAAO,mBAAoBT,SACpCO,SAASE,OAAO,SAAUP,iBAAiBQ,QAC3CH,SAASE,OAAO,MAAOP,iBAAiBS,KACxCJ,SAASE,OAAO,UAAWP,iBAAiBU,SAC5CL,SAASE,OAAO,UAAWlB,EAAEC,IAAIqB,SACjCN,SAASE,OAAO,YAAaP,iBAAiBY,WAC9CP,SAASE,OAAO,WAAY,KAC5BF,SAASE,OAAO,SAAUlB,EAAEC,IAAIuB,WAChCR,SAASE,OAAO,UAAWP,iBAAiBc,SAC5CT,SAASE,OAAO,SAAUP,iBAAiBe,YAEvCC,IAAMnB,SAASoB,MAAM,KACzBpB,SAAW,CAAEmB,IAAI,IAAM,GAAMA,IAAI,IAAM,IACvCX,SAASE,OAAO,kBAAYV,SAAS,GAAGqB,OAAO,EAAE,iBAAQrB,SAAS,KAElEK,IAAIpB,KAAK,OAAQO,EAAEC,IAAIC,QAAU,iDAAiD,GAClFW,IAAIiB,KAAKd,gBAGRpB,WAAWJ,MAAMY,SAAS2B,WAAa,SAASC,WACjC,oBAALhC,EACAgC,IAGJhC,EAAEiC,KAAKF,WAAWC,IAAK,kCAG7BpB,oBAAsB,iBACjBsB,SAAU,0BAAcxC,OAAQ,aAElCyC,OAAS,CACbA,QAAsB,GACtBA,OAAOZ,UAAYW,QAAQX,WAAa,EACxCY,OAAOf,IAAMc,QAAQd,KAAO,GAC5Be,OAAOV,QAAUS,QAAQE,gBAAkB,GAC3CD,OAAOhB,OAASe,QAAQf,QAAU,EAClCgB,OAAOT,OAASQ,QAAQR,QAAU,OAE9BW,KAAO,OACPA,QAAQH,QAAQI,gBACwB,WAApCJ,QAAQI,aAAaD,MAAME,KAAmB,CAC9CJ,OAAOd,QAAUa,QAAQI,aAAaD,MAAMG,aAKhDH,QAAQH,QAAQO,YACyB,OAArCP,QAAQO,SAASJ,MAAMK,UAAoB,CAC3CP,OAAOV,QAAUS,QAAQO,SAASJ,MAAMK,uBAKzCP,aAGNvC,WAAWJ,MAAMY,SAASuC,WAAa,kBACjCjD,OAAOiD,mBAGb/C,WAAWJ,MAAMY,SAASwC,WAAa,SAASC,SACjDnD,OAAOoD,YAAY,oBAAoB,EAAOD,SAC9C/C,KAAKF,WAAWJ,MAAMuD,mBAvFjBnD,WAAWJ,MAAMwD"}